# Scanning single-copy orthologs for positive selection using branch-site tests

We can use the IFIT2 gene (Ensembl ID: ENSG00000119922, NCBI Accession: NP_001538) orthologs (orthogroup OG0013267 in our analysis) as an example to demonstrate the analysis of positive selection conducted in our study. Further discussion of this gene is provided in our manuscript. 

The first step is to align the gene using the codon-aware aligner PRANK. I tested other aligners including the faster MAFFT but found that PRANK is less prone to misaligning indels, which can impact selection scans.

```
prank -showtree -d=OG0013267.fa -o=OG0013267 -codon -F -once -t=data/species.tre -prunetree
```

PRANK will generate the output aligned FASTA file `OG0013267.best.fas`, which can be used for conducting our positive selection scan. This file is also provided here in the `data` directory.

Let's execute our HYPHY aBSREL analysis on the PRANK codon-aligned sequences.

```
mv data/OG0013267.best.fas . 
run_absrel.sh OG0013267
```

This wrapper cleans the alignment, converts it to the right input format and runs HYPHY. We can then extract the branch-site test p-value for the bat node using a custom script to parse the output json file.
```
python scripts/parse_json.py OG0013267_ABSREL.json
Node10 1.327491068958686e-06
```
HYPHY gave our foreground node an arbitrary name (Node10) and we can see that the uncorrected p-value is significant (*p*<0.05). If we run more tests, this value will need to be adjusted for multiple testing.

We can als run the widely used software PAML to conduct a branch-site test. We have written a wrapper for PAML too, but be aware that it relies on the filtered alignment generated by the aBSREL wrapper, so we always run that first.

```
run_paml.sh OG0013267
```

The wrapper formats the input file to PAML phylip format and it sets up the `data/codeml.ctl` configuration file. PAML is run once under the null model and once with a model of selection in the foreground branch. The likelihoods of these two runs are then compared by the wrapper and written to `branchsite_delta_likelihood.txt`. A *p*-value can then be calculated under the assumption of a chi-squared distribution using a script we prepared.

```
scripts/paml_pval.sh branchsite_delta_likelihood.txt
OG0013267 bat 0.000000332
```

We can also use a wrapper to summarize aBSREL and PAML. This returns the orthogroup name, the tested branch, PAML *p*-value, aBSREL *p*-value, number of codons and the omega value. Though notice that the aBSREL *p*-value precision is lower than when using the `parse_json.py` script.

```
scripts/get_psg_result.sh OG0013267
OG0013267       bat     0.000000332     0.00000 466     0.53
```

In this case, the PAML *p*-value is also significant. Due to differences in the methods, aBSREL and PAML can sometimes yield strongly different results however. Therefore, a conservative approach can be to take the consensus significant genes found by both methods.

## Inferring the sites under selection

Further HYPHY analyses of interest are the MEME and BUSTED analyses that offer a different approach of identifying signals of selection by inferring the specific sites under selection. For details see [HYPHY](http://hyphy.org/).

```
hyphy MEME --tree data/meme.tre --alignment OG0013267.alltaxa.phy --branches Foreground --output OG0013267_meme.json > OG0013267.meme.out
hyphy BUSTED --tree data/meme.tre --alignment OG0013267.alltaxa.phy --branches Foreground --output OG0013267_busted.json > OG0013267.busted.out
```

Once the analysis is complete, we can summarize the results using a wrapper script.

```
scripts/get_sites.sh OG0013267
OG0013267       meme    55      0.0095
OG0013267       meme    114     0.0853
OG0013267       meme    151     0.0199
OG0013267       meme    152     0.0181
OG0013267       meme    163     0.0001
OG0013267       meme    186     0.0830
OG0013267       meme    196     0.0711
OG0013267       meme    235     0.0423
OG0013267       meme    256     0.0209
OG0013267       meme    284     0.0001
OG0013267       meme    293     0.0001
OG0013267       meme    307     0.0172
OG0013267       meme    325     0.0074
OG0013267       meme    330     0.0801
OG0013267       meme    385     0.0067
OG0013267       meme    413     0.0817
OG0013267       meme    417     0.0910
OG0013267       meme    426     0.0807
OG0013267       meme    442     0.0364
OG0013267       meme    457     0.0042
OG0013267       busted  163     35.02663275456297
OG0013267       busted  284     58.57346167017698
OG0013267       busted  293     49.33567607832335
```

The resulting table shows meme or busted results (column 4) for specific codon positions (column 3), where the MEME values are *p*-values and the BUSTED values are evidence ratios (site level likelihood ratios for omega>1). We can see that codons 163 and 284 show signs of selection in both tests.

## *P*-value correction

A simple way to correct *p*-values in R is shown below.
```
options(scipen=999)
pvals <- read.delim("bat_pvals.tsv",sep="\t")
pvals$abs_bat_fdr <- p.adjust(pvals$abs_bat, method="fdr")
write.table(pvals,"bat_pvals_fdr.tsv",sep = ",",row.names = FALSE, quote = FALSE)
```

## Gene onotology (GO) enrichment

Gene onotology (GO) enrichment can be run on the positively selected genes, using the other tested genes as the background. GO annotations can be downloaded from [BioMart](http://useast.ensembl.org/info/data/biomart/index.html) using the R package BiomaRt for example. Given a list of selected genes and a table of all genes and their GO annotations, the below script with run a GO enrichment analysis using the R package topGO.
```
scripts/topgo.R selected_genes.txt gene2go.txt
```

## Dependencies

* biopython
* HYPHY
* PAML
* topGO
